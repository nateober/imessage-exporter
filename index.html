<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Messages</title>
    <!-- Google Fonts: Warm & Personal Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Warm & Personal Color Palette */
            --primary-color: #E07A5F;
            --primary-hover: #C96A51;
            --accent-amber: #E8A946;
            --accent-sage: #9DB4A0;
            --accent-rose: #D4A5A5;

            /* Backgrounds */
            --background-color: #FDF6E3;
            --card-background: #FFFBF5;
            --sidebar-bg: #FAF4E8;

            /* Text Colors */
            --text-primary: #3D3229;
            --text-secondary: #6B5B4F;
            --text-light: #9A8A7B;

            /* Borders & Shadows */
            --border-color: #E8DFD1;
            --shadow-soft: 0 4px 20px rgba(61, 50, 41, 0.08);
            --shadow-lifted: 0 8px 30px rgba(61, 50, 41, 0.12);
            --shadow-polaroid: 0 4px 15px rgba(61, 50, 41, 0.15), 0 1px 3px rgba(61, 50, 41, 0.1);

            /* Message Bubbles */
            --message-received: #F5EDE3;
            --message-sent: #E8DFD1;
            --message-sent-text: #3D3229;

            /* Layout */
            --sidebar-width: 360px;
            --radius-soft: 16px;
            --radius-round: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            font-weight: 400;
        }

        /* Typography Classes */
        h1, h2, h3, .heading {
            font-family: 'Lora', Georgia, serif;
            font-weight: 600;
            color: var(--text-primary);
        }

        .handwritten, .date-label {
            font-family: 'Caveat', cursive;
            font-weight: 500;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: width 0.3s ease;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar-toggle {
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 20;
            box-shadow: var(--shadow-soft);
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .sidebar-toggle:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .sidebar-header {
            padding: 1.75rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(to bottom, var(--card-background), var(--sidebar-bg));
        }

        .sidebar.collapsed .sidebar-header h1 {
            display: none;
        }

        .sidebar-header h1 {
            font-family: 'Lora', Georgia, serif;
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        /* Contact Stats Bar */
        .contact-stats {
            padding: 0.75rem 1.5rem;
            background-color: rgba(253, 246, 227, 0.5);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Caveat', cursive;
            font-size: 1.1rem;
        }

        .sidebar.collapsed .contact-stats {
            display: none;
        }

        /* View Mode Toggle */
        .view-mode-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .view-mode-btn {
            padding: 0.35rem 0.75rem;
            border: 1px solid var(--border-color);
            background-color: var(--card-background);
            border-radius: var(--radius-soft);
            cursor: pointer;
            font-size: 0.75rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .view-mode-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .view-mode-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .contact-list {
            flex: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* Compact View */
        .contact-list.compact .contact-item {
            padding: 0.5rem 1rem;
        }

        .contact-list.compact .contact-avatar {
            width: 30px;
            height: 30px;
            font-size: 0.875rem;
        }

        .contact-list.compact .contact-preview {
            display: none;
        }

        /* Standard Contact Item */
        .contact-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.25s ease;
            position: relative;
            border-bottom: 1px solid rgba(232, 223, 209, 0.5);
        }

        .contact-item:hover {
            background-color: rgba(253, 246, 227, 0.7);
            transform: translateX(4px);
        }

        .contact-item.active {
            background: linear-gradient(135deg, var(--primary-color), #D46A4F);
            color: white;
            border-radius: 0 var(--radius-soft) var(--radius-soft) 0;
            margin-right: 8px;
            box-shadow: var(--shadow-soft);
        }

        /* Contact Item Tooltip */
        .contact-item::after {
            content: attr(data-full-name);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--text-primary);
            color: var(--card-background);
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-soft);
            font-size: 0.875rem;
            font-family: 'Nunito', sans-serif;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 100;
            margin-left: 0.5rem;
            box-shadow: var(--shadow-soft);
        }

        .contact-item:hover::after {
            opacity: 1;
        }

        .sidebar.collapsed .contact-item::after {
            left: 60px;
        }

        .contact-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-amber), var(--primary-color));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-family: 'Lora', serif;
            margin-right: 1rem;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(224, 122, 95, 0.3);
        }

        .sidebar.collapsed .contact-avatar {
            margin-right: 0;
        }

        .contact-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }

        .sidebar.collapsed .contact-info {
            display: none;
        }

        .contact-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            font-family: 'Nunito', sans-serif;
        }

        .contact-phone {
            font-size: 0.75rem;
            color: var(--text-light);
            font-family: 'Nunito', sans-serif;
        }

        .contact-item.active .contact-phone {
            color: rgba(255, 255, 255, 0.8);
        }

        .contact-preview {
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 0.2rem;
            font-style: italic;
        }

        .contact-meta {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.35rem;
        }

        .sidebar.collapsed .contact-meta {
            display: none;
        }

        .message-count {
            font-size: 0.8rem;
            background: linear-gradient(135deg, var(--accent-amber), var(--primary-color));
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: var(--radius-soft);
            min-width: 28px;
            text-align: center;
            font-weight: 600;
            font-family: 'Nunito', sans-serif;
            box-shadow: 0 2px 6px rgba(232, 169, 70, 0.3);
        }

        .contact-item.active .message-count {
            background: white;
            color: var(--primary-color);
            box-shadow: none;
        }

        .last-message-date {
            font-size: 1rem;
            color: var(--text-light);
            font-family: 'Caveat', cursive;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--background-color);
        }

        .tabs {
            display: flex;
            background-color: var(--card-background);
            border-bottom: 1px solid var(--border-color);
            padding: 0 1.5rem;
            gap: 0.5rem;
        }

        .tab {
            padding: 1.1rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 500;
            color: var(--text-secondary);
            border-radius: var(--radius-soft) var(--radius-soft) 0 0;
        }

        .tab:hover {
            background-color: rgba(253, 246, 227, 0.5);
            color: var(--text-primary);
        }

        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
            background-color: rgba(224, 122, 95, 0.05);
        }

        .tab-badge {
            font-size: 0.7rem;
            background-color: var(--text-light);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: var(--radius-soft);
            font-weight: 600;
        }

        .tab.active .tab-badge {
            background: linear-gradient(135deg, var(--accent-amber), var(--primary-color));
        }

        .tab-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: var(--card-background);
            padding: 1.75rem;
            border-radius: var(--radius-soft);
            box-shadow: var(--shadow-soft);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-amber), var(--primary-color), var(--accent-rose));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lifted);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card h3 {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-family: 'Nunito', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-card .value {
            font-size: 2.25rem;
            font-weight: 600;
            color: var(--primary-color);
            font-family: 'Lora', serif;
            line-height: 1.2;
        }

        .stat-card .subtitle {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.35rem;
            font-family: 'Caveat', cursive;
            font-size: 1.1rem;
        }

        /* Conversation Styles */
        .conversation-container {
            max-width: 850px;
            margin: 0 auto;
            width: 100%;
        }

        .conversation-header {
            background-color: var(--card-background);
            padding: 1.25rem 1.5rem;
            border-radius: var(--radius-soft);
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-color);
        }

        .conversation-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .conversation-avatar {
            width: 54px;
            height: 54px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-sage), var(--accent-amber));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.4rem;
            font-family: 'Lora', serif;
            box-shadow: 0 3px 10px rgba(157, 180, 160, 0.3);
        }

        .conversation-details h2 {
            margin: 0;
            font-size: 1.35rem;
            font-family: 'Lora', serif;
            color: var(--text-primary);
        }

        .conversation-details p {
            margin: 0.25rem 0 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-family: 'Caveat', cursive;
            font-size: 1.1rem;
        }

        .conversation-actions {
            display: flex;
            gap: 0.75rem;
        }

        .action-btn {
            padding: 0.6rem 1.25rem;
            border: 1px solid var(--border-color);
            background-color: var(--card-background);
            border-radius: var(--radius-soft);
            cursor: pointer;
            font-size: 0.875rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.25s ease;
        }

        .action-btn:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(224, 122, 95, 0.3);
        }

        .messages-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1.5rem;
            background-color: var(--card-background);
            border-radius: var(--radius-soft);
            min-height: 400px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-color);
        }

        .message-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-bottom: 1rem;
        }

        .message-date-separator {
            text-align: center;
            margin: 1.5rem 0;
            position: relative;
        }

        .message-date-separator span {
            background-color: var(--card-background);
            padding: 0.5rem 1.25rem;
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-family: 'Caveat', cursive;
            border-radius: var(--radius-round);
            border: 1px solid var(--border-color);
        }

        .message-date-separator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-color), transparent);
            z-index: -1;
        }

        .message {
            max-width: 72%;
            padding: 0.9rem 1.15rem;
            border-radius: var(--radius-round);
            word-wrap: break-word;
            position: relative;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--message-sent), #DDD4C6);
            color: var(--text-primary);
            border-bottom-right-radius: 6px;
            box-shadow: 0 2px 8px rgba(61, 50, 41, 0.08);
        }

        .message.received {
            align-self: flex-start;
            background-color: var(--message-received);
            color: var(--text-primary);
            border-bottom-left-radius: 6px;
            box-shadow: 0 2px 8px rgba(61, 50, 41, 0.06);
        }

        .message-time {
            font-size: 0.95rem;
            color: var(--text-light);
            margin-top: 0.35rem;
            font-family: 'Caveat', cursive;
        }

        .message.sent .message-time {
            color: var(--text-secondary);
        }

        /* Charts */
        .chart-container {
            background-color: var(--card-background);
            padding: 1.75rem;
            border-radius: var(--radius-soft);
            box-shadow: var(--shadow-soft);
            height: 420px;
            border: 1px solid var(--border-color);
        }

        .card {
            background-color: var(--card-background);
            padding: 1.75rem;
            border-radius: var(--radius-soft);
            box-shadow: var(--shadow-soft);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Lora', serif;
            color: var(--text-primary);
        }

        /* Image Grid - Polaroid Style */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.75rem;
            padding: 0.5rem;
        }

        .image-item {
            aspect-ratio: auto;
            overflow: visible;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            background-color: white;
            box-shadow: var(--shadow-polaroid);
            transition: all 0.35s ease;
            padding: 12px 12px 55px 12px;
            transform: rotate(calc(var(--rotation, 0) * 1deg));
        }

        .image-item:nth-child(3n) { --rotation: 2; }
        .image-item:nth-child(3n+1) { --rotation: -1.5; }
        .image-item:nth-child(3n+2) { --rotation: 1; }

        .image-item:hover {
            transform: rotate(0deg) translateY(-8px) scale(1.02);
            box-shadow: 0 12px 40px rgba(61, 50, 41, 0.2);
            z-index: 10;
        }

        .image-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            transition: all 0.3s ease;
            border-radius: 2px;
        }

        .image-item:hover img {
            filter: brightness(1.02);
        }

        .image-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: transparent;
            color: var(--text-secondary);
            padding: 6px 12px;
            opacity: 1;
            height: auto;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            gap: 2px;
        }

        .image-overlay .contact-name {
            font-size: 0.8rem;
            font-weight: 600;
            font-family: 'Nunito', sans-serif;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
        }

        .image-overlay .image-date {
            font-size: 0.95rem;
            font-family: 'Caveat', cursive;
            color: var(--text-light);
            line-height: 1.2;
        }

        .image-loading {
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-light);
            font-family: 'Caveat', cursive;
            font-size: 1.1rem;
        }

        /* Search */
        .search-container {
            padding: 0;
        }

        .sidebar.collapsed .search-container {
            padding: 0.5rem;
        }

        .search-input {
            width: 100%;
            padding: 0.85rem 1rem;
            padding-left: 2.75rem;
            border-radius: var(--radius-round);
            border: 1px solid var(--border-color);
            outline: none;
            font-size: 0.9rem;
            font-family: 'Nunito', sans-serif;
            background-color: var(--card-background);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%239A8A7B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>');
            background-repeat: no-repeat;
            background-position: 12px center;
            transition: all 0.25s ease;
        }

        .sidebar.collapsed .search-input {
            display: none;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(224, 122, 95, 0.1);
        }

        .search-input::placeholder {
            color: var(--text-light);
            font-style: italic;
        }

        .message-search-container {
            margin-bottom: 1.25rem;
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            gap: 1.25rem;
            margin-bottom: 1.25rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-family: 'Nunito', sans-serif;
            font-weight: 500;
        }

        .filter-group select,
        .filter-group input {
            padding: 0.6rem 0.85rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-soft);
            outline: none;
            font-family: 'Nunito', sans-serif;
            font-size: 0.875rem;
            background-color: var(--card-background);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(224, 122, 95, 0.1);
        }

        .image-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.25rem;
            font-size: 1rem;
            color: var(--text-secondary);
            font-family: 'Caveat', cursive;
        }

        /* Empty States */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: var(--text-light);
            padding: 3rem;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 1.5rem;
            opacity: 0.4;
            color: var(--accent-rose);
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
            color: var(--text-secondary);
            font-family: 'Lora', serif;
        }

        .empty-state p {
            color: var(--text-light);
            max-width: 400px;
            font-family: 'Nunito', sans-serif;
            line-height: 1.6;
        }

        /* Loading States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }

        .loading-spinner {
            border: 4px solid var(--border-color);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 44px;
            height: 44px;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(61, 50, 41, 0.97);
            animation: fadeIn 0.3s ease;
        }

        .lightbox.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
            background: white;
            padding: 16px 16px 60px 16px;
            border-radius: 4px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .lightbox-content img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 2px;
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: var(--card-background);
            font-size: 36px;
            font-weight: normal;
            cursor: pointer;
            z-index: 1001;
            background-color: var(--primary-color);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(224, 122, 95, 0.4);
        }

        .lightbox-close:hover {
            background-color: var(--primary-hover);
            transform: scale(1.1);
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: var(--card-background);
            font-size: 28px;
            cursor: pointer;
            padding: 18px;
            background-color: var(--primary-color);
            border-radius: var(--radius-soft);
            user-select: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(224, 122, 95, 0.3);
        }

        .lightbox-nav:hover {
            background-color: var(--primary-hover);
            transform: translateY(-50%) scale(1.05);
        }

        .lightbox-prev {
            left: 20px;
        }

        .lightbox-next {
            right: 20px;
        }

        .lightbox-info {
            position: absolute;
            bottom: 10px;
            left: 16px;
            right: 16px;
            color: var(--text-primary);
            text-align: center;
            background-color: transparent;
            padding: 0;
        }

        .lightbox-info h3 {
            margin: 0;
            font-size: 1rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            color: var(--text-primary);
        }

        .lightbox-info p {
            margin: 0.25rem 0 0;
            font-size: 1.1rem;
            font-family: 'Caveat', cursive;
            color: var(--text-light);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Entrance Animations */
        .stat-card {
            animation: fadeInUp 0.5s ease-out both;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }
        .stat-card:nth-child(5) { animation-delay: 0.5s; }
        .stat-card:nth-child(6) { animation-delay: 0.6s; }

        .chart-container {
            animation: fadeInScale 0.6s ease-out 0.3s both;
        }

        .card {
            animation: fadeInUp 0.5s ease-out both;
        }

        .image-item {
            animation: fadeInUp 0.4s ease-out both;
        }

        /* Network Container */
        .network-container {
            height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--sidebar-bg);
            border-radius: var(--radius-soft);
            border: 1px solid var(--border-color);
        }

        /* Scroll to Top Button */
        .scroll-to-top {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, var(--accent-amber), var(--primary-color));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(224, 122, 95, 0.35);
            opacity: 0;
            transform: translateY(100px);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .scroll-to-top.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .scroll-to-top:hover {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(224, 122, 95, 0.45);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            :root {
                --sidebar-width: 300px;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 50vh;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .sidebar-toggle {
                display: none;
            }

            .main-content {
                height: 50vh;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .message {
                max-width: 85%;
            }

            .image-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab {
                white-space: nowrap;
            }

            .filter-controls {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
            }

            .filter-group select,
            .filter-group input {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                height: 40vh;
            }

            .main-content {
                height: 60vh;
            }

            .contact-item {
                padding: 0.75rem 1rem;
            }

            .image-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }

        /* Print Styles */
        @media print {
            .sidebar,
            .tabs,
            .search-container,
            .filter-controls,
            .scroll-to-top,
            .lightbox {
                display: none !important;
            }

            .main-content {
                width: 100%;
            }

            .tab-content {
                display: block !important;
                page-break-after: always;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle Sidebar">
                <span id="sidebarToggleIcon">â€¹</span>
            </div>
            <div class="sidebar-header">
                <h1>My Messages</h1>
                <div class="search-container">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search contacts...">
                </div>
            </div>
            <div class="contact-stats">
                <span id="contactCount">0 contacts</span>
                <div class="view-mode-toggle">
                    <button class="view-mode-btn active" onclick="setViewMode('standard')">Standard</button>
                    <button class="view-mode-btn" onclick="setViewMode('compact')">Compact</button>
                </div>
            </div>
            <div class="contact-list" id="contactList">
                <!-- Contacts will be loaded here -->
            </div>
        </div>

        <div class="main-content">
            <div class="tabs">
                <div class="tab active" data-tab="overview">
                    Overview
                    <span class="tab-badge" id="overviewBadge"></span>
                </div>
                <div class="tab" data-tab="conversation">
                    Conversation
                    <span class="tab-badge" id="conversationBadge" style="display: none;"></span>
                </div>
                <div class="tab" data-tab="attachments">
                    Attachments
                    <span class="tab-badge" id="attachmentsBadge"></span>
                </div>
                <div class="tab" data-tab="network">Network</div>
            </div>

            <div class="tab-content active" id="overviewTab">
                <div class="stats-grid" id="statsGrid">
                    <!-- Stats will be loaded here -->
                </div>
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>

            <div class="tab-content" id="conversationTab">
                <div class="conversation-container">
                    <div class="message-search-container">
                        <input type="text" class="search-input" id="messageSearchInput" placeholder="Search messages...">
                    </div>
                    <div class="conversation-header" id="conversationHeader">
                        <div class="empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                            <h3>No Conversation Selected</h3>
                            <p>Select a contact from the sidebar to view your conversation history</p>
                        </div>
                    </div>
                    <div class="messages-container" id="messagesContainer">
                        <!-- Messages will be loaded here -->
                    </div>
                </div>
            </div>

            <div class="tab-content" id="attachmentsTab">
                <div class="card">
                    <div class="card-title">
                        <span>Shared Images</span>
                        <button class="action-btn" onclick="loadMoreImages()">Load More</button>
                    </div>
                    <div class="filter-controls">
                        <div class="filter-group">
                            <label>Contact:</label>
                            <select id="imageContactFilter">
                                <option value="">All Contacts</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Date Range:</label>
                            <input type="date" id="imageDateFrom">
                            <span>to</span>
                            <input type="date" id="imageDateTo">
                        </div>
                        <div class="filter-group">
                            <button class="action-btn" onclick="clearImageFilters()">Clear Filters</button>
                        </div>
                    </div>
                    <div class="image-stats">
                        <span id="imageCount">0 images</span>
                        <span id="imageContactCount">0 contacts</span>
                    </div>
                    <div class="image-grid" id="imageGrid">
                        <!-- Images will be loaded here -->
                    </div>
                </div>
            </div>

            <div class="tab-content" id="networkTab">
                <div class="card">
                    <div class="card-title">Your Top 15 Conversations</div>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem; font-family: 'Caveat', cursive; font-size: 1.15rem;">Messages sent vs received for each contact</p>
                    <div class="network-container" id="networkContainer" style="height: 550px;">
                        <canvas id="networkChart"></canvas>
                    </div>
                </div>
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-title">Messaging Insights</div>
                    <div id="networkStats" class="stats-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox">
        <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
        <span class="lightbox-nav lightbox-prev" onclick="navigateLightbox(-1)">â€¹</span>
        <span class="lightbox-nav lightbox-next" onclick="navigateLightbox(1)">â€º</span>
        <div class="lightbox-content">
            <img id="lightboxImage" src="" alt="">
        </div>
        <div class="lightbox-info" id="lightboxInfo">
            <h3 id="lightboxContactName"></h3>
            <p id="lightboxImageInfo"></p>
        </div>
    </div>

    <!-- Scroll to Top Button -->
    <div class="scroll-to-top" id="scrollToTop" onclick="scrollToTop()" title="Scroll to Top">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 15l-6-6-6 6"/>
        </svg>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables
        let appData = null;
        let currentContactId = null;
        let filteredImages = [];
        let currentImageIndex = 0;
        let allMessages = [];
        let filteredMessages = [];
        let imageLoadOffset = 0;
        const imageLoadLimit = 50;
        let viewMode = 'standard';

        // Function to load data from JSON file
        function loadDataFromJson() {
            fetch('imessage_data.json?v=' + Date.now())
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Store data globally
                    appData = data;
                    allMessages = data.messages || [];
                    
                    // Initialize the app with loaded data
                    loadContacts();
                    loadStatistics();
                    loadImages();
                    setupImageFilters();
                    updateBadges();
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    document.getElementById('contactList').innerHTML = 
                        `<div class="empty-state">
                            <h3>Error Loading Data</h3>
                            <p>Please check if imessage_data.json exists and try refreshing the page.</p>
                            <p style="font-size: 0.875rem; margin-top: 1rem;">Error: ${error.message}</p>
                        </div>`;
                });
        }

        // Update tab badges
        function updateBadges() {
            if (!appData) return;
            
            // Overview badge
            const totalMessages = appData.statistics?.totalMessages || 0;
            document.getElementById('overviewBadge').textContent = totalMessages > 999 ? '999+' : totalMessages;
            
            // Attachments badge
            const totalImages = appData.images?.length || 0;
            document.getElementById('attachmentsBadge').textContent = totalImages > 999 ? '999+' : totalImages;
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('sidebarToggleIcon');
            
            sidebar.classList.toggle('collapsed');
            icon.textContent = sidebar.classList.contains('collapsed') ? 'â€º' : 'â€¹';
        }

        // Set view mode
        function setViewMode(mode) {
            viewMode = mode;
            const contactList = document.getElementById('contactList');
            const buttons = document.querySelectorAll('.view-mode-btn');
            
            buttons.forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase() === mode);
            });
            
            if (mode === 'compact') {
                contactList.classList.add('compact');
            } else {
                contactList.classList.remove('compact');
            }
        }

        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return date.toLocaleTimeString('en-US', { 
                    hour: 'numeric',
                    minute: '2-digit'
                });
            } else if (diffDays === 1) {
                return 'Yesterday';
            } else if (diffDays < 7) {
                return date.toLocaleDateString('en-US', { weekday: 'long' });
            } else {
                return date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
                });
            }
        }

        // Format full date
        function formatFullDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Format short date
        function formatShortDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric'
            });
        }

        // Load contacts into sidebar
        function loadContacts() {
            const contactList = document.getElementById('contactList');
            contactList.innerHTML = '';
            
            if (!appData.contacts || appData.contacts.length === 0) {
                contactList.innerHTML = '<div class="empty-state"><p>No contacts found</p></div>';
                return;
            }
            
            // Update contact count
            document.getElementById('contactCount').textContent = `${appData.contacts.length} contacts`;

            // Precompute most recent message date for each contact
            const contactLastMessageDate = {};
            appData.contacts.forEach(contact => {
                const contactMessages = appData.messages.filter(m => m.contactId === contact.id);
                if (contactMessages.length > 0) {
                    // Find the most recent date
                    const dates = contactMessages.map(m => new Date(m.date));
                    contactLastMessageDate[contact.id] = Math.max(...dates);
                } else {
                    contactLastMessageDate[contact.id] = 0;
                }
            });

            // Sort contacts by most recent message date (newest first)
            const sortedContacts = [...appData.contacts].sort((a, b) =>
                contactLastMessageDate[b.id] - contactLastMessageDate[a.id]
            );

            sortedContacts.forEach(contact => {
                const contactEl = document.createElement('div');
                contactEl.className = 'contact-item';
                contactEl.dataset.contactId = contact.id;

                // Use displayName for unnamed group chats, otherwise use name
                const displayName = contact.displayName || contact.name;
                contactEl.dataset.fullName = displayName;

                // Get avatar initial - for groups, use a group icon character
                const avatarInitial = contact.isGroupChat ? 'ðŸ‘¥' : displayName.charAt(0).toUpperCase();

                // Get most recent message for preview and date
                const contactMessages = appData.messages.filter(m => m.contactId === contact.id);
                // Sort by date descending to get most recent first
                contactMessages.sort((a, b) => new Date(b.date) - new Date(a.date));
                const lastMessage = contactMessages[0];
                const preview = lastMessage ? lastMessage.content.substring(0, 50) + '...' : 'No messages';
                const lastDate = lastMessage ? formatDate(lastMessage.date) : '';

                // For group chats, show participant count instead of phone
                const subtitle = contact.isGroupChat && contact.participants
                    ? `${contact.participants.length} participants`
                    : formatPhoneNumber(contact.phone);

                contactEl.innerHTML = `
                    <div class="contact-avatar">${avatarInitial}</div>
                    <div class="contact-info">
                        <div class="contact-name">${displayName}</div>
                        <div class="contact-phone">${subtitle}</div>
                        <div class="contact-preview">${preview}</div>
                    </div>
                    <div class="contact-meta">
                        <div class="last-message-date">${lastDate}</div>
                        <div class="message-count">${contact.messageCount}</div>
                    </div>
                `;

                contactEl.addEventListener('click', () => selectContact(contact));
                contactList.appendChild(contactEl);
            });
        }

        // Format phone number for display
        function formatPhoneNumber(phone) {
            // If it's not a phone number, return as is
            if (!phone.startsWith('+') || phone.includes('@')) {
                return phone;
            }
            
            // Simple US phone number formatting
            const cleaned = phone.replace(/\D/g, '');
            if (cleaned.length === 11 && cleaned.startsWith('1')) {
                return `(${cleaned.substr(1, 3)}) ${cleaned.substr(4, 3)}-${cleaned.substr(7)}`;
            }
            
            return phone;
        }

        // Select contact and load conversation
        function selectContact(contact) {
            currentContactId = contact.id;
            
            // Update active state
            document.querySelectorAll('.contact-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-contact-id="${contact.id}"]`).classList.add('active');
            
            // Update conversation badge
            const badge = document.getElementById('conversationBadge');
            badge.textContent = contact.messageCount;
            badge.style.display = 'inline-block';
            
            // Switch to conversation tab
            document.querySelector('[data-tab="conversation"]').click();
            
            // Load conversation
            loadConversation(contact);
        }

        // Load conversation for selected contact
        function loadConversation(contact) {
            const header = document.getElementById('conversationHeader');
            const container = document.getElementById('messagesContainer');

            // Use displayName for unnamed group chats
            const displayName = contact.displayName || contact.name;
            const avatarContent = contact.isGroupChat ? 'ðŸ‘¥' : displayName.charAt(0).toUpperCase();

            // Show participants for group chats, phone for individual
            const subtitle = contact.isGroupChat && contact.participants
                ? `${contact.participants.length} participants â€¢ ${contact.messageCount} messages`
                : `${formatPhoneNumber(contact.phone)} â€¢ ${contact.messageCount} messages`;

            // Update header
            header.innerHTML = `
                <div class="conversation-info">
                    <div class="conversation-avatar">${avatarContent}</div>
                    <div class="conversation-details">
                        <h2>${displayName}</h2>
                        <p>${subtitle}</p>
                    </div>
                </div>
                <div class="conversation-actions">
                    <button class="action-btn" onclick="exportConversation()">Export</button>
                    <button class="action-btn" onclick="showContactImages()">Images</button>
                </div>
            `;
            
            container.innerHTML = '';
            
            // Filter messages for this contact
            const messages = appData.messages.filter(m => m.contactId === contact.id);
            filteredMessages = messages;
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No messages with this contact</p></div>';
                return;
            }
            
            // Display messages
            displayMessages(messages);
        }

        // Display messages with date separators
        function displayMessages(messages) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            let lastDate = null;
            
            messages.forEach((message, index) => {
                const messageDate = new Date(message.date).toDateString();
                
                // Add date separator if needed
                if (messageDate !== lastDate) {
                    const separator = document.createElement('div');
                    separator.className = 'message-date-separator';
                    separator.innerHTML = `<span>${formatDateSeparator(message.date)}</span>`;
                    container.appendChild(separator);
                    lastDate = messageDate;
                }
                
                const messageEl = document.createElement('div');
                messageEl.className = `message ${message.isFromMe ? 'sent' : 'received'}`;
                
                messageEl.innerHTML = `
                    <div class="message-content">${escapeHtml(message.content)}</div>
                    <div class="message-time">${formatTime(message.date)}</div>
                `;
                
                container.appendChild(messageEl);
            });
            
            // Scroll to bottom
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        // Format date separator
        function formatDateSeparator(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return 'Today';
            } else if (diffDays === 1) {
                return 'Yesterday';
            } else if (diffDays < 7) {
                return date.toLocaleDateString('en-US', { weekday: 'long' });
            } else {
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric',
                    month: 'long', 
                    day: 'numeric'
                });
            }
        }

        // Format time
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('en-US', { 
                hour: 'numeric',
                minute: '2-digit'
            });
        }

        // Search messages
        function searchMessages(searchTerm) {
            if (!searchTerm) {
                displayMessages(filteredMessages);
                return;
            }
            
            const filtered = filteredMessages.filter(message => 
                message.content.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            displayMessages(filtered);
        }

        // Export conversation
        function exportConversation() {
            if (!currentContactId || !filteredMessages.length) return;
            
            const contact = appData.contacts.find(c => c.id === currentContactId);
            const text = filteredMessages.map(m => 
                `[${formatFullDate(m.date)}] ${m.isFromMe ? 'Me' : contact.name}: ${m.content}`
            ).join('\n');
            
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conversation_${contact.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Show contact images
        function showContactImages() {
            if (!currentContactId) return;
            
            // Switch to attachments tab
            document.querySelector('[data-tab="attachments"]').click();
            
            // Set filter to current contact
            document.getElementById('imageContactFilter').value = currentContactId;
            loadImages();
        }

        // Escape HTML for security
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load statistics
        function loadStatistics() {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';
            
            if (!appData.statistics) {
                return;
            }
            
            const stats = appData.statistics;
            
            // Calculate additional stats
            const messagesPerDay = Math.round(stats.totalMessages / 
                ((new Date(stats.dateRange.end) - new Date(stats.dateRange.start)) / (1000 * 60 * 60 * 24)));
            
            // Create stat cards
            const statCards = [
                { 
                    title: 'Total Messages', 
                    value: stats.totalMessages.toLocaleString(),
                    subtitle: `${messagesPerDay} per day average`
                },
                { 
                    title: 'Messages Sent', 
                    value: stats.messagesSent.toLocaleString(),
                    subtitle: `${Math.round(stats.messagesSent / stats.totalMessages * 100)}% of total`
                },
                { 
                    title: 'Messages Received', 
                    value: stats.messagesReceived.toLocaleString(),
                    subtitle: `${Math.round(stats.messagesReceived / stats.totalMessages * 100)}% of total`
                },
                { 
                    title: 'Unique Contacts', 
                    value: stats.uniqueContacts.toLocaleString(),
                    subtitle: `${Math.round(stats.totalMessages / stats.uniqueContacts)} msgs per contact`
                },
                { 
                    title: 'Average Message Length', 
                    value: Math.round(stats.avgMessageLength) + ' chars',
                    subtitle: 'Per message'
                },
                { 
                    title: 'Date Range', 
                    value: `${formatShortDate(stats.dateRange.start)} - ${formatShortDate(stats.dateRange.end)}`,
                    subtitle: `${Math.round((new Date(stats.dateRange.end) - new Date(stats.dateRange.start)) / (1000 * 60 * 60 * 24))} days`
                }
            ];
            
            statCards.forEach(stat => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <h3>${stat.title}</h3>
                    <div class="value">${stat.value}</div>
                    ${stat.subtitle ? `<div class="subtitle">${stat.subtitle}</div>` : ''}
                `;
                statsGrid.appendChild(card);
            });
            
            // Create hourly distribution chart
            if (stats.hourlyDistribution) {
                createHourlyChart(stats.hourlyDistribution);
            }
        }

        // Create hourly distribution chart
        function createHourlyChart(hourlyData) {
            const ctx = document.getElementById('hourlyChart').getContext('2d');

            // Handle both array of objects [{hour, count}] and simple array [count, count, ...]
            const isSimpleArray = typeof hourlyData[0] === 'number';
            const labels = isSimpleArray
                ? hourlyData.map((_, hour) => {
                    if (hour === 0) return '12 AM';
                    if (hour === 12) return '12 PM';
                    return hour > 12 ? `${hour - 12} PM` : `${hour} AM`;
                })
                : hourlyData.map(d => {
                    const hour = d.hour;
                    if (hour === 0) return '12 AM';
                    if (hour === 12) return '12 PM';
                    return hour > 12 ? `${hour - 12} PM` : `${hour} AM`;
                });
            const data = isSimpleArray ? hourlyData : hourlyData.map(d => d.count);

            // Create gradient for bars
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(232, 169, 70, 0.85)');
            gradient.addColorStop(0.5, 'rgba(224, 122, 95, 0.75)');
            gradient.addColorStop(1, 'rgba(212, 165, 165, 0.65)');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Messages by Hour',
                        data: data,
                        backgroundColor: gradient,
                        borderColor: 'rgba(224, 122, 95, 0.9)',
                        borderWidth: 1,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(154, 138, 123, 0.15)'
                            },
                            ticks: {
                                font: { family: 'Nunito' },
                                color: '#6B5B4F',
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { family: 'Caveat', size: 14 },
                                color: '#9A8A7B'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Message Activity by Hour of Day',
                            font: {
                                family: 'Lora',
                                size: 18,
                                weight: '600'
                            },
                            color: '#3D3229',
                            padding: { bottom: 20 }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(61, 50, 41, 0.9)',
                            titleFont: { family: 'Nunito', weight: '600' },
                            bodyFont: { family: 'Caveat', size: 16 },
                            cornerRadius: 12,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y.toLocaleString()} messages`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Network chart instance
        let networkChartInstance = null;

        // Render network visualization
        function renderNetworkChart() {
            const ctx = document.getElementById('networkChart').getContext('2d');

            // Destroy existing chart if it exists
            if (networkChartInstance) {
                networkChartInstance.destroy();
            }

            // Get top 15 contacts by message count
            const topContacts = [...appData.contacts]
                .sort((a, b) => b.messageCount - a.messageCount)
                .slice(0, 15);

            // Calculate sent/received for each contact
            const contactStats = topContacts.map(contact => {
                const messages = appData.messages.filter(m => m.contactId === contact.id);
                const sent = messages.filter(m => m.isFromMe).length;
                const received = messages.length - sent;
                return { ...contact, sent, received };
            });

            // Create gradient
            const gradient = ctx.createLinearGradient(0, 0, ctx.canvas.width, 0);
            gradient.addColorStop(0, 'rgba(232, 169, 70, 0.85)');
            gradient.addColorStop(0.5, 'rgba(224, 122, 95, 0.85)');
            gradient.addColorStop(1, 'rgba(212, 165, 165, 0.85)');

            networkChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: contactStats.map(c => c.name.length > 20 ? c.name.substring(0, 18) + '...' : c.name),
                    datasets: [
                        {
                            label: 'Sent',
                            data: contactStats.map(c => c.sent),
                            backgroundColor: 'rgba(224, 122, 95, 0.8)',
                            borderColor: 'rgba(224, 122, 95, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        },
                        {
                            label: 'Received',
                            data: contactStats.map(c => c.received),
                            backgroundColor: 'rgba(157, 180, 160, 0.8)',
                            borderColor: 'rgba(157, 180, 160, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            grid: { color: 'rgba(154, 138, 123, 0.1)' },
                            ticks: {
                                font: { family: 'Nunito', size: 11 },
                                color: '#6B5B4F',
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        },
                        y: {
                            stacked: true,
                            grid: { display: false },
                            ticks: {
                                font: { family: 'Nunito', size: 12, weight: '500' },
                                color: '#3D3229'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'end',
                            labels: {
                                font: { family: 'Nunito', size: 12 },
                                color: '#6B5B4F',
                                usePointStyle: true,
                                pointStyle: 'rectRounded',
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(61, 50, 41, 0.95)',
                            titleFont: { family: 'Lora', size: 14, weight: '600' },
                            bodyFont: { family: 'Nunito', size: 13 },
                            cornerRadius: 12,
                            padding: 14,
                            callbacks: {
                                title: function(context) {
                                    return contactStats[context[0].dataIndex].name;
                                },
                                afterTitle: function(context) {
                                    const stat = contactStats[context[0].dataIndex];
                                    return `Total: ${stat.messageCount.toLocaleString()} messages`;
                                },
                                label: function(context) {
                                    const label = context.dataset.label;
                                    const value = context.parsed.x;
                                    const stat = contactStats[context.dataIndex];
                                    const percent = Math.round((value / stat.messageCount) * 100);
                                    return `${label}: ${value.toLocaleString()} (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Update stats with more useful insights
            const statsContainer = document.getElementById('networkStats');
            const totalMessages = appData.contacts.reduce((sum, c) => sum + c.messageCount, 0);
            const totalSent = appData.messages.filter(m => m.isFromMe).length;
            const totalReceived = appData.messages.length - totalSent;
            const sentRatio = Math.round((totalSent / appData.messages.length) * 100);
            const groupChats = appData.contacts.filter(c => c.isGroupChat).length;
            const individualChats = appData.contacts.length - groupChats;

            // Find your chattiest relationship (most balanced conversation)
            const balancedContact = contactStats
                .map(c => ({ ...c, balance: Math.abs(50 - (c.sent / c.messageCount * 100)) }))
                .filter(c => c.messageCount > 50) // Only meaningful conversations
                .sort((a, b) => a.balance - b.balance)[0];

            // Top 3 contacts represent what % of messages
            const top3Total = contactStats.slice(0, 3).reduce((sum, c) => sum + c.messageCount, 0);
            const top3Percent = Math.round((top3Total / totalMessages) * 100);

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <h3>Your Message Ratio</h3>
                    <div class="value">${sentRatio}% sent</div>
                    <div class="subtitle">${totalSent.toLocaleString()} sent, ${totalReceived.toLocaleString()} received</div>
                </div>
                <div class="stat-card">
                    <h3>Most Balanced Chat</h3>
                    <div class="value">${balancedContact?.name || 'N/A'}</div>
                    <div class="subtitle">${balancedContact ? Math.round(balancedContact.sent / balancedContact.messageCount * 100) + '% you, ' + Math.round(balancedContact.received / balancedContact.messageCount * 100) + '% them' : ''}</div>
                </div>
                <div class="stat-card">
                    <h3>Top 3 Contacts</h3>
                    <div class="value">${top3Percent}%</div>
                    <div class="subtitle">of all your messages</div>
                </div>
                <div class="stat-card">
                    <h3>Chat Breakdown</h3>
                    <div class="value">${individualChats} / ${groupChats}</div>
                    <div class="subtitle">individual / group chats</div>
                </div>
            `;
        }

        // Setup image filters
        function setupImageFilters() {
            if (!appData.contacts) return;
            
            const contactFilter = document.getElementById('imageContactFilter');
            
            // Clear existing options
            contactFilter.innerHTML = '<option value="">All Contacts</option>';
            
            // Add contact options sorted by name
            const sortedContacts = [...appData.contacts].sort((a, b) => a.name.localeCompare(b.name));
            sortedContacts.forEach(contact => {
                const option = document.createElement('option');
                option.value = contact.id;
                option.textContent = `${contact.name} (${contact.messageCount})`;
                contactFilter.appendChild(option);
            });
            
            // Set date range if we have data
            if (appData.statistics && appData.statistics.dateRange) {
                document.getElementById('imageDateFrom').value = appData.statistics.dateRange.start.split('T')[0];
                document.getElementById('imageDateTo').value = appData.statistics.dateRange.end.split('T')[0];
            }
        }

        // Clear image filters
        function clearImageFilters() {
            document.getElementById('imageContactFilter').value = '';
            document.getElementById('imageDateFrom').value = '';
            document.getElementById('imageDateTo').value = '';
            loadImages();
        }

        // Load images
        function loadImages(append = false) {
            const imageGrid = document.getElementById('imageGrid');
            
            if (!append) {
                imageGrid.innerHTML = '';
                imageLoadOffset = 0;
            }
            
            if (!appData.images || appData.images.length === 0) {
                imageGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <h3>No Images Found</h3>
                        <p>No image attachments were found in your messages.</p>
                    </div>`;
                updateImageStats(0, 0);
                return;
            }
            
            // Apply filters
            filteredImages = filterImages();
            
            // Update stats
            const uniqueContacts = new Set(filteredImages.map(img => img.contactId)).size;
            updateImageStats(filteredImages.length, uniqueContacts);
            
            // Get images to show
            const imagesToShow = filteredImages.slice(imageLoadOffset, imageLoadOffset + imageLoadLimit);
            
            imagesToShow.forEach((image, index) => {
                const actualIndex = imageLoadOffset + index;
                const imageEl = document.createElement('div');
                imageEl.className = 'image-item';
                imageEl.dataset.imageIndex = actualIndex;

                // Try multiple ways to find the contact
                let contact = null;
                if (image.contactId) {
                    contact = appData.contacts.find(c => c.id === image.contactId);
                }
                if (!contact && image.contactName) {
                    // Try matching by phone number or name
                    contact = appData.contacts.find(c =>
                        c.phone === image.contactName ||
                        c.name === image.contactName ||
                        (c.phone && image.contactName && c.phone.replace(/\D/g, '').includes(image.contactName.replace(/\D/g, '')))
                    );
                }

                const displayName = contact ? contact.name : (image.contactName || 'Unknown');

                imageEl.innerHTML = `
                    <div class="image-loading">Loading...</div>
                    <img src="${image.url}"
                         alt="Shared by ${displayName}"
                         loading="lazy"
                         onerror="this.style.display='none'; this.parentElement.querySelector('.image-loading').textContent='Failed to load';"
                         onload="this.parentElement.querySelector('.image-loading').style.display='none';">
                    <div class="image-overlay">
                        <div class="contact-name">${displayName}</div>
                        <div class="image-date">${formatDate(image.date)}</div>
                    </div>
                `;

                imageEl.addEventListener('click', () => openLightbox(actualIndex));
                imageGrid.appendChild(imageEl);
            });
            
            imageLoadOffset += imagesToShow.length;
            
            // Show/hide load more button
            const loadMoreBtn = document.querySelector('[onclick="loadMoreImages()"]');
            if (loadMoreBtn) {
                loadMoreBtn.style.display = imageLoadOffset < filteredImages.length ? 'inline-block' : 'none';
            }
        }

        // Load more images
        function loadMoreImages() {
            loadImages(true);
        }

        // Filter images based on current filter settings
        function filterImages() {
            if (!appData.images) return [];
            
            let filtered = [...appData.images];
            
            // Contact filter
            const contactId = document.getElementById('imageContactFilter').value;
            if (contactId) {
                filtered = filtered.filter(img => img.contactId == contactId);
            }
            
            // Date filter
            const dateFrom = document.getElementById('imageDateFrom').value;
            const dateTo = document.getElementById('imageDateTo').value;
            
            if (dateFrom) {
                filtered = filtered.filter(img => img.date >= dateFrom);
            }
            
            if (dateTo) {
                filtered = filtered.filter(img => img.date <= dateTo + 'T23:59:59');
            }
            
            return filtered;
        }

        // Update image statistics
        function updateImageStats(imageCount, contactCount) {
            document.getElementById('imageCount').textContent = `${imageCount.toLocaleString()} images`;
            document.getElementById('imageContactCount').textContent = `${contactCount} contacts`;
        }

        // Lightbox functions
        function openLightbox(index) {
            currentImageIndex = index;
            const image = filteredImages[index];

            // Try multiple ways to find the contact
            let contact = null;
            if (image.contactId) {
                contact = appData.contacts.find(c => c.id === image.contactId);
            }
            if (!contact && image.contactName) {
                contact = appData.contacts.find(c =>
                    c.phone === image.contactName ||
                    c.name === image.contactName ||
                    (c.phone && image.contactName && c.phone.replace(/\D/g, '').includes(image.contactName.replace(/\D/g, '')))
                );
            }
            const displayName = contact ? contact.name : (image.contactName || 'Unknown');

            document.getElementById('lightboxImage').src = image.url;
            document.getElementById('lightboxContactName').textContent = displayName;
            document.getElementById('lightboxImageInfo').innerHTML = `
                ${formatFullDate(image.date)}<br>
                Image ${index + 1} of ${filteredImages.length}
            `;

            document.getElementById('lightbox').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            document.body.style.overflow = '';
        }

        function navigateLightbox(direction) {
            currentImageIndex += direction;
            
            if (currentImageIndex < 0) {
                currentImageIndex = filteredImages.length - 1;
            } else if (currentImageIndex >= filteredImages.length) {
                currentImageIndex = 0;
            }
            
            openLightbox(currentImageIndex);
        }

        // Scroll to top
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Handle scroll events
        function handleScroll() {
            const scrollBtn = document.getElementById('scrollToTop');
            if (window.pageYOffset > 300) {
                scrollBtn.classList.add('visible');
            } else {
                scrollBtn.classList.remove('visible');
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Load data from JSON file
            loadDataFromJson();
            
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;

                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabName}Tab`).classList.add('active');

                    // Render network chart when tab is clicked
                    if (tabName === 'network' && appData.contacts) {
                        renderNetworkChart();
                    }
                });
            });

            // Contact search
            document.getElementById('searchInput').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                
                document.querySelectorAll('.contact-item').forEach(item => {
                    const contactName = item.querySelector('.contact-name').textContent.toLowerCase();
                    const contactPhone = item.querySelector('.contact-phone').textContent.toLowerCase();
                    const contactPreview = item.querySelector('.contact-preview').textContent.toLowerCase();
                    
                    if (contactName.includes(searchTerm) || 
                        contactPhone.includes(searchTerm) || 
                        contactPreview.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });

            // Message search
            document.getElementById('messageSearchInput').addEventListener('input', function() {
                searchMessages(this.value);
            });

            // Image filters
            document.getElementById('imageContactFilter').addEventListener('change', () => loadImages());
            document.getElementById('imageDateFrom').addEventListener('change', () => loadImages());
            document.getElementById('imageDateTo').addEventListener('change', () => loadImages());

            // Keyboard navigation for lightbox
            document.addEventListener('keydown', function(e) {
                if (document.getElementById('lightbox').classList.contains('active')) {
                    if (e.key === 'Escape') closeLightbox();
                    if (e.key === 'ArrowLeft') navigateLightbox(-1);
                    if (e.key === 'ArrowRight') navigateLightbox(1);
                }
            });

            // Close lightbox on background click
            document.getElementById('lightbox').addEventListener('click', function(e) {
                if (e.target === this) closeLightbox();
            });

            // Scroll events
            window.addEventListener('scroll', handleScroll);

            // Handle window resize
            window.addEventListener('resize', function() {
                // Adjust sidebar on mobile
                if (window.innerWidth <= 768) {
                    document.getElementById('sidebar').classList.remove('collapsed');
                }
            });
        });
    </script>
</body>
</html>